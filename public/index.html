<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Luminosidade</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
        }

        h1 {
            margin-top: 20px;
        }

        .valor-atual {
            font-size: 2.5em;
            margin: 10px 0 20px 0;
            color: #38bdf8;
        }

        .conteiner {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            background-color: #1e293b;
            padding: 15px;
            border-radius: 12px;
        }

        .buttons {
            display: flex;
            align-items: center;
            width: 220px;
            justify-content: space-around;
            gap: 10px;
            margin-top: 20px;
        }

        .buttons button {
            background-color: #2563eb;
            color: white;
            padding: 8px;
            border: none;
            border-radius: 6px;
            width: 90px;
            cursor: pointer;
        }

        .buttons p {
            font-size: 1.3em;
        }

        .filtro-data {
            margin-bottom: 15px;
        }
    </style>
</head>

<body>

<h1>Monitor de Luminosidade</h1>
<div class="valor-atual" id="valorAtual">-- lx</div>

<div class="filtro-data">
    <input type="date" id="seletorData">
</div>

<div class="conteiner">
    <canvas id="grafico" width="700" height="350"></canvas>

    <div class="buttons">
        <button id="anterior">Anterior</button>
        <p id="num"></p>
        <button id="proximo">Próximo</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    let paginaAtual = 1;
    let meuGrafico;
    let dataSelecionada = "";

    const numpaginas = document.getElementById('num');
    const valorAtual = document.getElementById('valorAtual');
    const seletorData = document.getElementById('seletorData');

    seletorData.addEventListener("change", () => {
        dataSelecionada = seletorData.value;
        paginaAtual = 1;
        criarGrafico(paginaAtual);
    });

    async function lerDados(pagina) {
        try {
            let url = `/dados?pagina=${pagina}`;

            if (dataSelecionada) {
                url += `&data=${dataSelecionada}`;
            }

            const resposta = await fetch(url);
            return await resposta.json();
        } catch (error) {
            console.error("Erro ao ler dados:", error);
            return [];
        }
    }

    async function atualizarValorAtual() {
        try {
            const resposta = await fetch('/dados/ultimo');
            const dado = await resposta.json();

            if (dado && dado.luminosidade !== undefined) {
                valorAtual.innerText = dado.luminosidade + " lx";
            }
        } catch (error) {
            console.error("Erro ao buscar último valor:", error);
        }
    }

    async function criarGrafico(pagina) {

        const dadosPorPagina = await lerDados(pagina);
        numpaginas.innerText = pagina;

        if (!dadosPorPagina.length) {
            if (meuGrafico) meuGrafico.destroy();
            return;
        }

        if (meuGrafico) {
            meuGrafico.destroy();
        }

        const timestamps = dadosPorPagina.map(item => {
            const date = new Date(item.createdAt);
            return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        });

        const luminosidade = dadosPorPagina.map(item => item.luminosidade);

        const min = Math.min(...luminosidade);
        const max = Math.max(...luminosidade);

        const ctx = document.getElementById('grafico').getContext('2d');

        meuGrafico = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timestamps,
                datasets: [{
                    data: luminosidade,
                    borderColor: '#38bdf8',
                    borderWidth: 3,
                    tension: 0.35,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    y: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        suggestedMin: min - 20,
                        suggestedMax: max + 20
                    }
                }
            }
        });
    }

    document.getElementById("anterior").onclick = () => {
        if (paginaAtual > 1) {
            paginaAtual--;
            criarGrafico(paginaAtual);
        }
    };

    document.getElementById("proximo").onclick = () => {
        paginaAtual++;
        criarGrafico(paginaAtual);
    };

    criarGrafico(1);
    atualizarValorAtual();
    setInterval(atualizarValorAtual, 10000);

});
</script>

</body>
</html>